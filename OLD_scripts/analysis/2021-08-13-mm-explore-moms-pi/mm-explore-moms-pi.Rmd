---
title: "MM's first exploration of MOMS-PI trajectories"
description: |
  This script does some follow-up examination to JN's first exploration of the
  impact of calibration on microbiome trajectories within individual subjects.
author:
  - name: Michael R. McLaren
    url: {}
date: 2021-08-13
output:
  distill::distill_article:
    self_contained: true
    toc: true
    dev: svg
---

# Setup

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  cache = TRUE,
  autodep = TRUE,
  echo = TRUE,
  fig.dim = c(6,6)
)
```


```{r}
library(tidyverse)
library(here)
library(speedyseq)
library(metacal)

library(cowplot)
theme_set(theme_cowplot())
library(patchwork)
```

```{r}
otu <- here("output", "stirrups-profiles", "abundance-matrix.csv.bz2") %>%
  read_csv(
    col_types = cols(.default = col_double(), sample_name = col_character())
  ) %>%
  otu_table(taxa_are_rows = FALSE)
sam <- here("output", "stirrups-profiles", "sample-data.csv.bz2") %>%
  read_csv(col_types = "ccccccic") %>%
  mutate(across(host_visit_number, factor, ordered = TRUE)) %>%
  sample_data
tax <- here("output", "stirrups-profiles", "taxonomy.csv.bz2") %>%
  read_csv(col_types = cols(.default = col_character())) %>%
  tax_table %>%
  mutate_tax_table(
    species = case_when(!is.na(genus) ~ .otu)
  )
ps <- phyloseq(otu, sam, tax)
taxa_names(ps) <- taxa_names(ps) %>% 
  str_replace("(?<=Lactobacillus_crispatus)_cluster", "")
taxa_names(ps) %>% str_subset("crispatus")
```

# Calibration

## Generate bias vector

For calibration, we need a vector with the efficiencies of all OTUs.
We do this by first estimating the efficiencies for the species included in the Brooks et al mock communities.
We can do this by running the exmaple code in the docs for `metacal::estimate_bias()`.

```{r}
# Load data from the cellular mock communities of Brooks et al 2015
dr <- system.file("extdata", package = "metacal")
list.files(dr)
actual <- file.path(dr, "brooks2015-actual.csv") |>
  read.csv(row.names = "Sample") |>
  as("matrix")
observed <- file.path(dr, "brooks2015-observed.csv") |>
  read.csv(row.names = "Sample") |>
  subset(select = - Other) |>
  as("matrix")

# Estimate bias with bootstrapping for error estimation
mc_fit <- estimate_bias(observed, actual, margin = 1, boot = TRUE)
summary(mc_fit)

rm(actual, observed, dr)
```

```{r}
control_species <- mc_fit %>% coef %>% names
stopifnot(all(control_species %in% taxa_names(ps)))
```

We'll just use the point estimate, ignoring the uncertainty, since the standard errors are so small.

We don't have a way to directly estimate the efficiencies of the other OTUs, so we'll impute them as follows.

1. Set the efficiencies of the 7 control species to the directly estimated values
2. Compute efficiencies for the 6 control genera to the efficiency of the control species (if only one) or the geometric mean efficiency (if more than one; here this is just _Lactobacillus_)
3. Use these genera-level efficiencies for the efficiencies of OTUs that are not control species but are in the same genus as one
4. For other OTUs, use the geometric mean of the genera efficiencies; this is similar to using the mean of the 7 control species but gives _Lactobacillus_ equal weight to the other genera.

<!--  -->

```{r}
bias_species <- coef(mc_fit) %>% 
  enframe("species", "efficiency") %>%
  print
bias_genus <- bias_species %>%
  mutate(genus = str_extract(species, "^[^_]+"), .before = 1) %>%
  with_groups(genus, summarize, across(efficiency, gm_mean)) %>%
  print
# Match on genus or species, depending on which is available; then set others
# to average genus efficiency
bias_all <- tax_table(ps) %>% as_tibble %>%
  left_join(bias_species, by = "species") %>%
  left_join(bias_genus, by = "genus") %>%
  mutate(
    efficiency = case_when(
      !is.na(efficiency.x) ~ efficiency.x,
      !is.na(efficiency.y) ~ efficiency.y,
      TRUE ~ gm_mean(bias_genus$efficiency)
    )
  ) %>%
  select(-efficiency.x, -efficiency.y) %>%
  # standardize to L. iners, the most efficiently measured
  mutate(
    across(efficiency, ~ . / max(.))
  ) %>%
  glimpse
bias_all_vec <- bias_all %>% select(.otu, efficiency) %>% deframe 
```

## Observed and calibrated proportions

Compute observed and calibrated proportions with all taxa.

```{r}
ps.obs <- ps %>% 
  # prune_taxa(control_species, .) %>%
  transform_sample_counts(close_elts)
# note, calibrate() automatically subsets to just the focal taxa if we haven't
# already
ps.cal <- ps.obs %>% calibrate(bias_all_vec)
```

## Mean efficiencies

To compute the mean efficiencies, we can use `metacal::perturb()` to multiply efficiencies by the actual proportions for each sample (using `norm = "none"` to avoid renormalizing the results), then summing up the values from each sample with `phyloseq::sample_sums()`.

```{r}
# Compute the mean efficiencies and add to the sample data
mean_eff <- perturb(ps.cal, bias_all_vec, norm = "none") %>% 
  sample_sums %>%
  enframe('.sample', 'mean_efficiency') %>%
  left_join(sam %>% as_tibble, by = '.sample')
```

An alternative approach to compute the vector of mean efficiencies using base R is

```{r}
f <- function(x, bias) {sum(x * bias) / sum(x)}
mat <- ps.cal %>% orient_taxa(as = "columns") %>% otu_table %>% as("matrix")
stopifnot(identical(colnames(mat), names(bias_all_vec)))
me <- apply(mat, 1, f, bias = bias_all_vec)
stopifnot(all.equal(mean_eff$mean_efficiency, unname(me)))
rm(f, mat, me)
```

# Subject with the most visits (EP154266)

## Recapitulate Jacob's analysis

Jacob's analysis subsets to the control taxa prior to normalizing to proportions.

```{r}
x <- list(Calibrated = ps.cal, Observed = ps.obs) %>%
  map(~prune_taxa(control_species, .)) %>%
  map(transform_sample_counts, fun = close_elts) %>%
  map_dfr(as_tibble, .id = "type") %>%
  mutate(otu_abbrev = .otu %>% str_replace("_", " ") %>% abbreviate)
```

```{r, fig.dim = c(8, 6)}
x %>%
  filter(host_subject_id == "EP154266") %>%
  ggplot(aes(host_visit_number, .abundance, fill = .otu)) +
  facet_wrap(~type) +
  geom_col()
```

```{r, fig.dim = c(8, 6)}
x %>%
  filter(host_subject_id == "EP154266") %>%
  ggplot(aes(host_visit_number, .abundance, color = .otu)) +
  facet_wrap(~type) +
  geom_line(aes(group = .otu))
```

```{r}
x %>%
  filter(host_subject_id == "EP154266") %>%
  ggplot(aes(host_visit_number, .abundance, color = type)) +
  facet_grid(otu_abbrev~., scales = 'free_y') +
  geom_line(aes(group = type))
```

```{r}
x %>%
  filter(host_subject_id == "EP154266") %>%
  ggplot(aes(host_visit_number, .abundance, color = type)) +
  scale_y_log10() +
  facet_grid(otu_abbrev~., scales = 'free_y') +
  geom_line(aes(group = type))
```

same but with fixed scales

```{r}
x %>%
  filter(host_subject_id == "EP154266") %>%
  ggplot(aes(host_visit_number, .abundance, color = type)) +
  scale_y_log10() +
  facet_grid(otu_abbrev~., scales = 'fixed') +
  geom_line(aes(group = type))
```

This is perhaps a useful example to show how the effect of bias can be small.

Note, Sneathia and L iners have nearly the same efficiency, which is why calibration has almost no effect on Sneathia in the samples where L. iners dominates.

## Proportions w.r.t. all OTUs

What if we look at these same taxa, but proportions relative to all taxa,

```{r, fig.dim = c(8, 6)}
x1 <- list(Calibrated = ps.cal, Observed = ps.obs) %>%
  map(~prune_taxa(control_species, .)) %>%
  map_dfr(as_tibble, .id = "type") %>%
  mutate(otu_abbrev = .otu %>% str_replace("_", " ") %>% abbreviate)
x1 %>%
  filter(host_subject_id == "EP154266") %>%
  ggplot(aes(host_visit_number, .abundance, fill = .otu)) +
  facet_wrap(~type) +
  geom_col()
```

We can see that there is a big effect of first filtering to the control taxa, especially in the last visit.

```{r}
p1 <- x1 %>%
  filter(host_subject_id == "EP154266") %>%
  ggplot(aes(host_visit_number, .abundance, color = type)) +
  scale_y_log10() +
  facet_grid(otu_abbrev~., scales = 'fixed') +
  geom_line(aes(group = type))
p1
```

but the story in terms of how bias affects the fold changes of the control taxa doesn't change much.

To understand, look at the mean efficiency,

```{r}
p2 <- mean_eff %>%
  filter(host_subject_id == "EP154266") %>%
  ggplot(aes(host_visit_number, mean_efficiency)) +
  scale_y_log10(limits = c(1e-1, 1)) +
  geom_line(aes(group = 1))
p1 / p2 + plot_layout(heights = c(1, 0.2))
```

Can look at the FCs at t1 and t8 to see type of dynamics we indicate in the manuscript.
Might be handy to have a function that computes fold changes.

```{r}
```


### Including other taxa

What about other taxa that are fairly abundant in this subject?
To speed up melting, subset to the subject first,

```{r}
# tmp <- mean_eff %>% 
#   filter(host_subject_id == "EP154266") %>%
#   rename(.abundance = mean_efficiency) %>%
#   mutate(type = "Mean efficiency", .otu = "Mean efficiency") 

x2 <- list(Calibrated = ps.cal, Observed = ps.obs) %>%
  map(filter_sample_data, host_subject_id == "EP154266") %>%
  # map(~prune_taxa(control_species, .)) %>%
  map_dfr(as_tibble, .id = "type") %>%
  mutate(otu_abbrev = .otu %>% str_replace("_", " ") %>% abbreviate) %>%
  with_groups(.otu, mutate, 
    mean = mean(.abundance),
    median = median(.abundance)
  )
  # %>%
  # bind_rows(tmp)
```

```{r, fig.dim = c(6, 4)}
p1 <- x2 %>%
  select(.otu, mean, median) %>%
  distinct %>%
  ggplot(aes(mean + 1e-7)) +
  geom_histogram() +
  scale_x_log10()
p2 <- x2 %>%
  select(.otu, mean, median) %>%
  distinct %>%
  ggplot(aes(median + 1e-7)) +
  geom_histogram() +
  scale_x_log10()
p1 + p2
```

```{r}
p1 <- x2 %>%
  filter(median > 1e-3) %>%
  ggplot(aes(host_visit_number, .abundance, color = type)) +
  scale_y_log10() +
  facet_grid(otu_abbrev~., scales = 'fixed') +
  geom_line(aes(group = type)) +
  theme(legend.position = 'top')
p1
```

We can see sign errors or approximate sign errors around visit 8.
In gard, from 8 to 9 there is an observed decrease but a calibated increase.
For L. iners, there is an observed approximate constancy, but calibrated dip and recover

```{r}
p2 <- mean_eff %>%
  filter(host_subject_id == "EP154266") %>%
  ggplot(aes(host_visit_number, mean_efficiency)) +
  scale_y_log10() +
  scale_y_log10(limits = c(1e-2, 1e1)) +
  geom_line(aes(group = 1))
p1 / p2 + plot_layout(heights = c(1, 0.1))
```

need to set the y axis to have a similar scale to be comparable.

```{r}
rng <- gm_range(p1$data$.abundance %>% {.[.>0]})
```

Could check the FCs of all taxa from T1 to T2, and around T8

# Subject EP247202

```{r}
x1 %>%
  filter(host_subject_id == "EP247202") %>%
  ggplot(aes(host_visit_number, .abundance, color = type)) +
  scale_y_log10() +
  facet_grid(otu_abbrev~., scales = 'fixed') +
  geom_line(aes(group = type))
```

