---
title: "MOMS_PI_Calibration"
author: "Jacob T. Nearing"
date: "7/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(phyloseq)
library(tidyverse)
library(ggbeeswarm)
library(cowplot)

library(metacal)
library(reshape2)

theme_set(theme_cowplot())
```

# Load in data from brooks et al


```{r}
brooks_theor_ab_file <- system.file(file.path("extdata", "brooks2015-actual.csv"), package = "metacal")

brooks_measure_ab_file <- system.file(file.path("extdata", "brooks2015-observed.csv"), package = "metacal")

brooks_meta_file <- system.file(file.path("extdata", "brooks2015-sample-data.csv"), package="metacal")

## read in files



brooks_theor_ab <- read.csv(brooks_theor_ab_file)
brooks_measure_ab <- read.csv(brooks_measure_ab_file)
brooks_meta <- read.csv(brooks_meta_file)
```

#examine measured and theorictal

First we will just try and recreate some of the plots in the eLife paper and tutorial from metacal using this dataset 
This will help me get use to what is going on with this data.
```{r}
#convert to RA.
brooks_measure_ab_ra <- sweep(brooks_measure_ab[,-1], 1, rowSums(brooks_measure_ab[,-1]), '/')
#add sample column back in
brooks_measure_ab_ra$Sample <- brooks_measure_ab$Sample 


brooks_theor_ab_melt <- melt(brooks_theor_ab)
## assign theoritical ab here
brooks_theor_ab_melt$Type <- "Actual"
colnames(brooks_theor_ab_melt) <- c("Sample", "Taxa", "Actual_Value", "Type")

brooks_measure_ab_melt <- melt(brooks_measure_ab_ra)
brooks_measure_ab_melt$Type <- "Observed"
colnames(brooks_measure_ab_melt) <- c("Sample", "Taxa", "Observed_Value", "Type")


## combined them
comp_brooks_data <- left_join(brooks_theor_ab_melt, brooks_measure_ab_melt, by=c("Sample", "Taxa"))

## plot

comp_plot <- ggplot(comp_brooks_data, aes(x=Actual_Value, y=Observed_Value, fill=Taxa, color=Taxa)) + geom_point() + geom_quasirandom() + scale_color_brewer(type="qual", palette = 3) + geom_abline(color="grey")
comp_plot
```

As we can see the actual abundances for a number of taxda are very far off from the observed.
In particulare it looks like there is an over estimation of lacto (as shown in eLife paper) and sneathia.
Looks like there is a lower observed abundance of strep as well.

These are all good and expected based on previous results.

## Estiamte Bias

Lets use the mock data to estimate the bias of these 7 taxon.

```{r}
#prep the data frames

#method indicates that rows should be taxa and colmns samples...
rownames(brooks_measure_ab_ra) <- brooks_measure_ab_ra$Sample
flip_measure_brooks <- brooks_measure_ab_ra[,-9]
#remove the other column...
flip_measure_brooks <- as.matrix(flip_measure_brooks[,-8])

rownames(brooks_theor_ab) <- brooks_theor_ab$Sample
flip_theor_brooks <- as.matrix(brooks_theor_ab[,-1])


bias_estimate <- estimate_bias(flip_measure_brooks, flip_theor_brooks, boot=T, margin=1)

bias <- coef(bias_estimate)
summary(bias_estimate)
```

Awesome these bias estimates line up exactly to what was reported in brooks et al., and match my above observations!

## Check model fit

We are now going to test out calibration by calibarting the observed measurements with the above bias estimates

```{r}
coef_tb <- summary(bias_estimate)$coefficients

coef_tb %>%
  mutate(taxon = fct_reorder(taxon, estimate)) %>%
  ggplot(aes(taxon, estimate, 
      ymin = estimate / gm_se^2, ymax = estimate * gm_se^2)) +
  geom_hline(yintercept = 1, color = "grey") +
  geom_pointrange() +
  scale_y_log10() +
  coord_flip()

## interesting to see such small SE compared to tutorial datasets


fitted_vals <- fitted(bias_estimate) %>% melt
fitted_vals$Type <- "Fitted_Value"
colnames(fitted_vals) <- c("Sample", "Taxa", "Fitted_Value", "Type")

comp_brooks_data <- left_join(comp_brooks_data, fitted_vals, by=c("Sample", "Taxa"))

#hmmm the fitted values are way off here...

#what is going on ???
comp_plot_fitted <- ggplot(comp_brooks_data, aes(x=Actual_Value, y=Fitted_Value, fill=Taxa, color=Taxa)) + geom_point() + geom_quasirandom() + scale_color_brewer(type="qual", palette = 3) + geom_abline(color="grey")
comp_plot_fitted


both_plots <- plot_grid(comp_plot, comp_plot_fitted)
both_plots
```

Hmmm... The fitted values do not make sense here...
They are way off and in some cases further off than what was originally estimated...
These also don't match the plots in the eLife paper...
Something is off here...

Lets try and calibrate the observations to see how that works... maybe something is off in the fitted function.

#Calibration
```{r}
#to calibrate we have to add a pseudocount of 0.01
brooks_measure_ab_ra_ps <- as.matrix(brooks_measure_ab_ra[,c(-8,-9)] + 0.01)

calibrated_measures <- calibrate(brooks_measure_ab_ra_ps, bias, margin=1)

rownames(calibrated_measures) <- brooks_measure_ab_ra$Sample

melted_calibrated_measures <- melt(calibrated_measures)
melted_calibrated_measures$Type <- "Calibrated"
colnames(melted_calibrated_measures) <- c("Sample", "Taxa", "Calibrated_Value", "Type")


comp_brooks_data <- left_join(comp_brooks_data, melted_calibrated_measures, by=c("Sample", "Taxa"))

comp_plot_cal <- ggplot(comp_brooks_data, aes(x=Actual_Value, y=Calibrated_Value, fill=Taxa, color=Taxa)) + geom_point() + geom_quasirandom() + scale_color_brewer(type="qual", palette = 3) + geom_abline(color="grey")
comp_plot_cal

plot_all <- plot_grid(comp_plot, comp_plot_fitted, comp_plot_cal)
plot_all
```


Something odd is going on here not sure what it is...
